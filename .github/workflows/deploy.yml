name: RootLab Spring Server Deploy

on:
  push:
    branches: [ "STEP5" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Git Source Code Checkout
      - name: Checkout source
        uses: actions/checkout@v3

      # 2. JDK ì„¤ì¹˜ (Spring Boot 3.x ê¸°ì¤€)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'   # gradle ìºì‹±

      # 3. Gradle ê¶Œí•œ ë¶€ì—¬
      - name: Add permission for gradlew
        run: chmod +x ./gradlew

      # 4. Build
      - name: Build Spring Boot (bootJar)
        run: ./gradlew clean bootJar
        shell: bash

      # 5. í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ë²„ì „ ì´ë¦„ ìƒì„±
      - name: Versioning
        uses: 1466587594/get-current-time@v2
        id: time
        with:
          format: YYYY-MM-DD-HH-mm-ss
          utcOffset: "+09:00"

      # 6. ìƒì„±ëœ JAR íŒŒì¼ëª… í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
      - name: Set artifact name
        run: echo "ARTIFACT=$(ls ./build/libs | grep '.jar')" >> $GITHUB_ENV

      # 7. AWS EB ë°°í¬
      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          region: ap-northeast-2

          # ğŸ”¥ ë‹¹ì‹  í”„ë¡œì íŠ¸ ê¸°ì¤€ EB ì„¤ì •
          application_name: springweb
          environment_name: Springweb-env 

          version_label: "rootlab-${{ steps.time.outputs.formattedTime }}"
          deployment_package: "./build/libs/${{ env.ARTIFACT }}"
          wait_for_environment_recovery: 30
